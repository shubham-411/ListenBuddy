<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ListenBuddy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #74ABE2, #5563DE);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Segoe UI', sans-serif;
    }
    .chat-container {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0px 4px 15px rgba(0,0,0,0.2);
      padding: 30px;
      width: 400px;
    }
    #messages {
      border: 1px solid #ddd;
      border-radius: 10px;
      height: 250px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    .message {
      padding: 6px 10px;
      margin: 5px 0;
      border-radius: 8px;
    }
    .message.you {
      background: #d1e7dd;
      text-align: right;
    }
    .message.partner {
      background: #f8d7da;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <h3 class="text-center mb-3">üéßListen Buddy</h3>

    <div id="join-section">
      <div class="mb-3">
        <select id="role" class="form-select">
          <option value="listener">Listener üëÇ</option>
          <option value="speaker">Speaker üé§</option>
        </select>
      </div>
      <button class="btn btn-primary w-100" onclick="joinChat()">Join Chat</button>
      <div id="status" class="text-center mt-3 text-muted"></div>
    </div>

    <div id="chat" style="display:none;">
      <h6 class="text-center">Matched with <span id="partner" class="fw-bold"></span></h6>
      <div id="messages"></div>
      <div class="input-group">
        <input id="msg" class="form-control" placeholder="Type a message...">
        <button class="btn btn-success" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

<script>
  var socket = io();
  var currentRoom = null;
  var username = "";

  function joinChat() {
    var role = document.getElementById("role").value;
    socket.emit("join", {role: role });
    document.getElementById("status").innerText = "‚è≥ Looking for a partner...";
  }

  socket.on("matched", function(data) {
    currentRoom = data.room;
    if (data.your_username) {
    username = data.your_username;
  }
    document.getElementById("partner").innerText = data.partner;
    document.getElementById("status").innerText = "‚úÖ Matched! Start chatting.";
    document.getElementById("join-section").style.display = "none";
    document.getElementById("chat").style.display = "block";
  });

  socket.on("message", function(data) {
    addMessage(data.username, data.message, false);
  });

  socket.on("partner_left", function() {
    alert("‚ö†Ô∏è Your partner has left the chat. You will be redirected.");
    location.reload();
  });

  function sendMessage() {
    var msg = document.getElementById("msg").value.trim();
    if (!msg) return;

    socket.emit("send_message", { room: currentRoom, username: username, message: msg });
    addMessage(username, msg, true);
    document.getElementById("msg").value = "";
  }

  function addMessage(user, text, isYou) {
    var div = document.createElement("div");
    div.classList.add("message", isYou ? "you" : "partner");
    div.innerText = (isYou ? "You" : user) + ": " + text;
    document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
  }
</script>

</body>
</html>
